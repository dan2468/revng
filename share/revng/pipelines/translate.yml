#
# This file is distributed under the MIT License. See LICENSE.md for details.
#

Containers:
  - Name: module.ll
    Type: LLVMContainer
  - Name: input
    Type: Binary
  - Name: object.o
    Type: Object
  - Name: output
    Type: Translated
Branches:
  - Steps:
      - Name: Import
        Doc: |-
          A simple step that does not run any pipe.
          Its only purpose is to list a set of analysis that can be performed before lifting.
        Analyses:
          - Name: ImportBinary
            Type: ImportBinary
            UsedContainers: [input]
          - Name: AddPrimitiveTypes
            Type: AddPrimitiveTypes
            UsedContainers: [input]
      - Name: Lift
        Doc: |-
          This step takes the binary and lifts it, producing an LLVM module containing the `root` function.
          It also performs some basic optimizations.
        Pipes:
          - Type: Lift
            UsedContainers: [input, module.ll]
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes: [globaldce]
        Artifacts:
          Container: module.ll
          Kind: Root
          SingleTargetFilename: module_lifted.ll
          Doc: |-
            The `root` function, produced by lifting.
        Analyses:
          - Name: DetectABI
            Type: DetectABI
            UsedContainers: [module.ll]
      - Name: Recompile
        Doc: |-
          This the binary translation step.
          Given an LLVM module containing the `root` function, links the necessary runtime, optionally performs some optimizations, compiles the module to an object file and links it.
          The final outcome is the translated program, that can be executed for the target architecture.
          Currently, the only supported inputs are ELF binaries for Linux for the supported architectures, while the supported output is x86-64 ELF for Linux only.
        Pipes:
          - Type: LinkSupport
            UsedContainers: [module.ll]
          - Type: LLVMPipe
            UsedContainers: [module.ll]
            Passes: [O2]
            EnabledWhen: [O2]
          - Type: Compile
            UsedContainers: [module.ll, object.o]
          - Type: LinkForTranslation
            UsedContainers: [input, object.o, output]
        Artifacts:
          Container: output
          Kind: Translated
          SingleTargetFilename: translated_binary
          Doc: |-
            The translated version of the input binary.
            This artifact is an ELF executable for Linux x86-64 containing the `root` function plus the required runtime.
